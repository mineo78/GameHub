@model GamingPlatform.Models.GameLobby
@{
    var currentPlayer = ViewBag.PlayerName as string;
    ViewData["Title"] = Localizer["Room.Title", Model.Name].Value;
}

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root{
            --bg1:#0f0f1a;
            --bg2:#1a1a2e;
            --bg3:#16213e;
            --text:#e0e0e0;
            --muted:#a0aec0;

            --glass: rgba(255,255,255,0.03);
            --glass2: rgba(255,255,255,0.06);
            --border: rgba(255,255,255,0.10);

            --red:#ff6b6b;
            --cyan:#4ecdc4;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 50%, var(--bg3) 100%);
            min-height: 100vh;
            color: var(--text);
        }

        /* Titre */
        h1 {
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--red), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: .5rem;
        }

        /* Texte bootstrap "muted" mieux lisible sur fond sombre */
        .text-muted {
            color: var(--muted) !important;
        }

        /* Card glassmorphism */
        .card {
            background: var(--glass) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
            border-radius: 16px !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow:
                0 20px 50px rgba(0,0,0,0.40),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* List group items */
        .list-group-item.bg-transparent {
            background: var(--glass2) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: transform .2s ease, background .2s ease, border-color .2s ease;
        }

        .list-group-item.bg-transparent:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.08) !important;
            border-color: rgba(78,205,196,0.25) !important;
        }

        /* Bouton start (garde les mêmes classes Bootstrap, juste re-skin) */
        .btn.btn-success.btn-lg {
            background: linear-gradient(135deg, var(--cyan), #3dbdb5) !important;
            border: none !important;
            border-radius: 12px !important;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(78,205,196,0.18);
            transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
        }

        .btn.btn-success.btn-lg:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(78,205,196,0.26);
        }

        .btn.btn-success.btn-lg:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Petit polish sur le compteur */
        #playerCount {
            color: var(--cyan);
            font-weight: 700;
        }

        /* Message info */
        .text-info {
            color: rgba(78,205,196,0.95) !important;
        }
    </style>
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h1>@Localizer["Room.Title", Model.Name]</h1>
        <p class="text-muted">@Localizer["Room.Game"]: @Model.GameType</p>
    </div>

    <!-- Lien de partage pour le créateur -->
    @if (Model.HostName == currentPlayer)
    {
        <div class="card p-4 mb-4" style="max-width: 600px; margin: 0 auto;">
            <h5><i class="fa-solid fa-share-nodes"></i> Partager ce lobby</h5>
            <p class="text-muted small mb-2">Envoyez ce lien à vos amis pour qu'ils rejoignent la partie :</p>
            <div class="input-group">
                <input type="text" id="shareLink" class="form-control bg-dark text-light border-secondary" 
                       value="@ViewBag.ShareLink" readonly />
                <button class="btn btn-outline-info" type="button" id="copyLinkBtn" onclick="copyShareLink()">
                    <i class="fa-solid fa-copy"></i> Copier
                </button>
            </div>
            <small id="copySuccess" class="text-success mt-2 d-none">
                <i class="fa-solid fa-check"></i> Lien copié !
            </small>
        </div>
    }

    <div class="card p-4 mb-4" style="max-width: 600px; margin: 0 auto;">
        <h3>@Localizer["Lobby.Players"] (<span id="playerCount">@Model.Players.Count</span>/@Model.MaxPlayers)</h3>
        <ul id="playerList" class="list-group list-group-flush mt-3">
            @foreach (var player in Model.Players)
            {
                <li class="list-group-item bg-transparent text-light border-secondary">
                    <i class="fa-solid fa-user"></i> @player
                </li>
            }
        </ul>

        @if (Model.HostName == currentPlayer)
        {
            <div class="mt-4 text-center">
                <button id="startGameBtn" class="btn btn-success btn-lg" @(Model.Players.Count < 2 ? "disabled" : "")>
                    <i class="fa-solid fa-play"></i> @Localizer["Room.StartGame"]
                </button>
                <p id="waitingMsg" class="text-muted mt-2 @(Model.Players.Count < 2 ? "" : "d-none")">@Localizer["Room.WaitingOthers"]</p>
            </div>
        }
        else
        {
            <div class="mt-4 text-center">
                <p class="text-info">@Localizer["Room.WaitingHost"]</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.4/signalr.min.js"></script>
    <script>
        const lobbyId = '@Model.Id';
        const gameType = '@Model.GameType';
        const currentPlayer = '@currentPlayer';

        // Fonction pour copier le lien de partage
        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            if (linkInput) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    const successMsg = document.getElementById('copySuccess');
                    if (successMsg) {
                        successMsg.classList.remove('d-none');
                        setTimeout(() => successMsg.classList.add('d-none'), 2000);
                    }
                }).catch(err => {
                    // Fallback pour les navigateurs plus anciens
                    linkInput.select();
                    document.execCommand('copy');
                });
            }
        }
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/lobbyHub")
            .withAutomaticReconnect()
            .build();

        connection.start().then(() => {
            console.log("Connected to LobbyHub");
            connection.invoke("JoinLobbyGroup", lobbyId);
        }).catch(err => console.error(err));

        connection.on("PlayerJoined", (playerName) => {
            const list = document.getElementById("playerList");
            const li = document.createElement("li");
            li.className = "list-group-item bg-transparent text-light border-secondary";
            li.innerHTML = `<i class="fa-solid fa-user"></i> ${playerName}`;
            list.appendChild(li);
            
            const countSpan = document.getElementById("playerCount");
            const currentCount = parseInt(countSpan.textContent) + 1;
            countSpan.textContent = currentCount;

            const startBtn = document.getElementById("startGameBtn");
            const waitingMsg = document.getElementById("waitingMsg");
            
            if (startBtn && currentCount >= 2) {
                startBtn.disabled = false;
                if(waitingMsg) waitingMsg.classList.add("d-none");
            }
        });

        connection.on("GameStarted", (type) => {
            if (type === "Morpion") {
                window.location.href = `/Morpion/Game/${lobbyId}/${currentPlayer}`;
            } else if (type === "SpeedTyping") {
                window.location.href = `/SpeedTyping/Game/${lobbyId}?playerName=${encodeURIComponent(currentPlayer)}`;
            } else if (type === "Puissance4") {
                window.location.href = `/Puissance4/Game/${lobbyId}/${currentPlayer}`;
            }
        });

        const startBtn = document.getElementById("startGameBtn");
        if (startBtn) {
            startBtn.addEventListener("click", () => {
                connection.invoke("StartGame", lobbyId);
            });
        }
    </script>
}
